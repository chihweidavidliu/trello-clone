const a1_0x24e0=['url','FileStorage','EndOfRunMessage','assign','lifeCycle','parseCommand','OutputObfuscator','daemon','CloudRemoteCache','cloudEnabledTasksRunner','anyErrors','fs-extra','../../../utilities/environment','env','stringify','cloud-enabled-runner','getBranch','path','uploadedToStorage','./cloud-enabled-life-cycle','__awaiter','defineProperty','./cloud-remote-cache','maskedProperties','CloudEnabledLifeCycle','writeFileSync','../../api/error-reporter.api','done','../../../utilities/nx-imports','catch','removeTrailingSlash','storedHashes','./cloud-run.api','find','__esModule','obfuscate','push','CloudRunApi','length','taskId','runUrl','warn','NX_CLOUD_DISTRIBUTED_EXECUTION_ID','nx-cloud/lib/daemon/process-run-end','error','Nx\x20Cloud\x20wasn\x27t\x20able\x20to\x20store\x20artifacts.','ACCESS_TOKEN','apply','.commit','/runs/','printCacheHitsMessage','getRunGroup','agentRunningInDistributedExecution','next','../../terminal-output/output-obfuscator','generateUniqueLinkId','toString','subscribe','printMessages','map','Nx\x20Cloud\x20Problems','join','then','pathExists','encryptionKey','tasks-hashes-','resolve','startRun','../../file-storage/e2e-encryption','submitRunMetrics','accessToken','enabled','../../file-storage/file-storage','message','ENCRYPTION_KEY','VERBOSE_LOGGING','Executed\x20tasks\x20with\x20hashes:\x20','forEach','hash','DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE','value','exit','note','toISOString','local-cache-hit','../../terminal-output/end-of-run-message','filter','extractGitSha'];(function(_0x1be480,_0x24e0e9){const _0x3d1ab7=function(_0xe0de0c){while(--_0xe0de0c){_0x1be480['push'](_0x1be480['shift']());}};_0x3d1ab7(++_0x24e0e9);}(a1_0x24e0,0xd9));const a1_0x3d1a=function(_0x1be480,_0x24e0e9){_0x1be480=_0x1be480-0x0;let _0x3d1ab7=a1_0x24e0[_0x1be480];return _0x3d1ab7;};'use strict';var __awaiter=this&&this[a1_0x3d1a('0x43')]||function(_0x3cc65e,_0x2f16a9,_0x207973,_0x4038a3){function _0x1fd0ef(_0x23f39c){return _0x23f39c instanceof _0x207973?_0x23f39c:new _0x207973(function(_0xda029e){_0xda029e(_0x23f39c);});}return new(_0x207973||(_0x207973=Promise))(function(_0x37455d,_0xbbe6df){function _0x269097(_0x1997f1){try{_0x1d6d86(_0x4038a3['next'](_0x1997f1));}catch(_0x162c36){_0xbbe6df(_0x162c36);}}function _0x5064e0(_0x3493d8){try{_0x1d6d86(_0x4038a3['throw'](_0x3493d8));}catch(_0x1d6568){_0xbbe6df(_0x1d6568);}}function _0x1d6d86(_0x4546f3){_0x4546f3[a1_0x3d1a('0x4a')]?_0x37455d(_0x4546f3[a1_0x3d1a('0x27')]):_0x1fd0ef(_0x4546f3[a1_0x3d1a('0x27')])[a1_0x3d1a('0x15')](_0x269097,_0x5064e0);}_0x1d6d86((_0x4038a3=_0x4038a3[a1_0x3d1a('0x6')](_0x3cc65e,_0x2f16a9||[]))[a1_0x3d1a('0xc')]());});};Object[a1_0x3d1a('0x44')](exports,a1_0x3d1a('0x51'),{'value':!![]});exports[a1_0x3d1a('0x38')]=void 0x0;const message_reporter_1=require('../../terminal-output/message-reporter');const end_of_run_message_1=require(a1_0x3d1a('0x2c'));const output_obfuscator_1=require(a1_0x3d1a('0xd'));const cloud_enabled_life_cycle_1=require(a1_0x3d1a('0x42'));const file_storage_1=require(a1_0x3d1a('0x1f'));const e2e_encryption_1=require(a1_0x3d1a('0x1b'));const environment_1=require(a1_0x3d1a('0x3b'));const cloud_remote_cache_1=require(a1_0x3d1a('0x45'));const cloud_run_api_1=require(a1_0x3d1a('0x4f'));const fs_1=require('fs');const path=require(a1_0x3d1a('0x40'));const path_1=require(a1_0x3d1a('0x40'));const metric_logger_1=require('../../../utilities/metric-logger');const error_reporter_api_1=require(a1_0x3d1a('0x49'));const fs_extra_1=require(a1_0x3d1a('0x3a'));const id_generator_1=require('./id-generator');const remove_trailing_slash_1=require('../../../utilities/remove-trailing-slash');const {tasksRunner,output,cacheDirectory}=require(a1_0x3d1a('0x4b'));function createApi(_0x5e54ee,_0x39e27d,_0xffed9){const _0x21d22b=(0x0,environment_1['getMachineInfo'])();return new cloud_run_api_1[(a1_0x3d1a('0x54'))](_0x5e54ee,_0xffed9,_0x39e27d,_0x21d22b);}function storeTaskHashes(_0x3a5349,_0x263670,_0x3738cc){const _0x537c38=JSON[a1_0x3d1a('0x3d')](_0x3a5349[a1_0x3d1a('0x12')](_0x3e8e66=>({'taskId':_0x3e8e66[a1_0x3d1a('0x56')],'hash':_0x3e8e66[a1_0x3d1a('0x25')]})));if(environment_1[a1_0x3d1a('0x22')]){output[a1_0x3d1a('0x29')]({'title':a1_0x3d1a('0x23')+_0x537c38});}(0x0,fs_1[a1_0x3d1a('0x48')])(path[a1_0x3d1a('0x14')](_0x263670,a1_0x3d1a('0x18')+_0x3738cc),_0x537c38);}function storeLocalCacheHits(_0x3575da,_0x560c2a,_0x2c3eb7){const _0x4802c2=_0x3575da[a1_0x3d1a('0x2d')](_0x4d115a=>_0x4d115a['cacheStatus']===a1_0x3d1a('0x2b'))[a1_0x3d1a('0x12')](_0x49c0ba=>_0x49c0ba[a1_0x3d1a('0x25')]);_0x4802c2[a1_0x3d1a('0x24')](_0x4d0365=>_0x560c2a['store'](_0x4d0365,_0x2c3eb7));}function onComplete({daemon,options,fileStorage,remoteCache,api,outputObfuscator,runStartTime,messages,endOfRunMessage,taskExecutions,versionOfNxBefore133,inner,encryptionKey,storeInCurrentProcess,distributedExecutionId,runContext}){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x9aa671=new Date()[a1_0x3d1a('0x2a')]();const _0x4ebe0e=(0x0,environment_1[a1_0x3d1a('0x3f')])();const _0x39a18c={'command':outputObfuscator[a1_0x3d1a('0x52')]((0x0,environment_1[a1_0x3d1a('0x34')])()),'startTime':runStartTime,'endTime':_0x9aa671,'distributedExecutionId':distributedExecutionId,'branch':_0x4ebe0e,'runGroup':(0x0,environment_1[a1_0x3d1a('0xa')])(),'sha':_0x4ebe0e?(0x0,environment_1[a1_0x3d1a('0x2e')])():undefined,'inner':inner};const _0x22645a={'branch':_0x4ebe0e,'runGroup':(0x0,environment_1[a1_0x3d1a('0xa')])(),'ciExecutionId':(0x0,environment_1['getCIExecutionId'])(),'ciExecutionEnv':(0x0,environment_1['getCIExecutionEnv'])()};if(storeInCurrentProcess){if((0x0,environment_1[a1_0x3d1a('0xb')])(distributedExecutionId)){storeTaskHashes(taskExecutions,cacheDirectory,distributedExecutionId);storeLocalCacheHits(taskExecutions,remoteCache,cacheDirectory);}try{yield remoteCache['waitForStoreRequestsToComplete']();}catch(_0x325f11){output['error']({'title':a1_0x3d1a('0x4')});messages[a1_0x3d1a('0x11')]();return![];}for(const _0x59753b of fileStorage[a1_0x3d1a('0x4e')]){const _0x579e4d=taskExecutions[a1_0x3d1a('0x50')](_0x14d9f1=>_0x14d9f1[a1_0x3d1a('0x25')]===_0x59753b);if(!_0x579e4d){throw new Error('Task\x20with\x20hash\x20'+_0x59753b+'\x20isn\x27t\x20recorded');}_0x579e4d[a1_0x3d1a('0x41')]=!![];}try{yield api['endRun'](_0x39a18c,taskExecutions,_0x22645a);}catch(_0x425b1f){output[a1_0x3d1a('0x3')]({'title':'Nx\x20Cloud\x20wasn\x27t\x20able\x20to\x20record\x20its\x20run.'});messages[a1_0x3d1a('0x11')]();return![];}yield(0x0,metric_logger_1[a1_0x3d1a('0x1c')])(options);}else{try{const _0x1cbb46=environment_1[a1_0x3d1a('0x5')]?environment_1[a1_0x3d1a('0x5')]:options[a1_0x3d1a('0x1d')];const _0x56cd7f=(0x0,id_generator_1[a1_0x3d1a('0xe')])();const _0x29afc7=require[a1_0x3d1a('0x19')](a1_0x3d1a('0x2'));yield daemon['processInBackground'](_0x29afc7,{'encryptionKey':encryptionKey,'runnerOptions':Object[a1_0x3d1a('0x32')](Object[a1_0x3d1a('0x32')]({},options),{'accessToken':_0x1cbb46}),'delayedStoreRequests':remoteCache['delayedStoreRequests'],'ciExecutionContext':_0x22645a,'runEnd':{'runData':_0x39a18c,'taskExecutions':taskExecutions,'linkId':_0x56cd7f}});runContext[a1_0x3d1a('0x57')]=(0x0,remove_trailing_slash_1[a1_0x3d1a('0x4d')])(options[a1_0x3d1a('0x2f')]||'https://nx.app')+a1_0x3d1a('0x8')+_0x56cd7f;}catch(_0x3a6883){output[a1_0x3d1a('0x0')]({'title':a1_0x3d1a('0x13'),'bodyLines':[_0x3a6883[a1_0x3d1a('0x20')]||_0x3a6883[a1_0x3d1a('0xf')]()]});return![];}}if(versionOfNxBefore133){setTimeout(()=>{messages[a1_0x3d1a('0x11')]();if(!messages[a1_0x3d1a('0x39')]&&!inner){endOfRunMessage['printCacheHitsMessage']();}},0x0);}else{messages[a1_0x3d1a('0x11')]();if(!messages[a1_0x3d1a('0x39')]&&!inner){endOfRunMessage[a1_0x3d1a('0x9')]();}}return!![];});}function createLifeCycle(_0x2ad4ac,_0x3baa6f,_0x3e6463,_0x59536c){const _0x556083=new cloud_enabled_life_cycle_1[(a1_0x3d1a('0x47'))](_0x2ad4ac,cacheDirectory,!![],_0x3baa6f['cacheableOperations']||[],_0x3e6463,_0x59536c);try{const {CompositeLifeCycle}=require(a1_0x3d1a('0x4b'));if(!CompositeLifeCycle)return _0x556083;return new CompositeLifeCycle([_0x3baa6f[a1_0x3d1a('0x33')],_0x556083]);}catch(_0x46b0ba){return _0x556083;}}function fetchUrlsForKnownHashesUpfront(_0x231af8,_0x5bd290,_0xa914b2,_0x296e14,_0x2e6eec){return __awaiter(this,void 0x0,void 0x0,function*(){if(_0x296e14['skipNxCache'])return;let _0x166c85=_0xa914b2[a1_0x3d1a('0x12')](_0x2a052d=>_0x2a052d[a1_0x3d1a('0x25')])['filter'](_0x443a2e=>!!_0x443a2e);const _0x40a166=yield Promise['all'](_0x166c85['map'](_0x1745f5=>{const _0x4d59ef=(0x0,path_1[a1_0x3d1a('0x14')])(cacheDirectory,_0x1745f5+a1_0x3d1a('0x7'));return(0x0,fs_extra_1[a1_0x3d1a('0x16')])(_0x4d59ef);}));const _0x3b2718=[];for(let _0x41048b=0x0;_0x41048b<_0x40a166[a1_0x3d1a('0x55')];++_0x41048b){if(!_0x40a166[_0x41048b]){_0x3b2718[a1_0x3d1a('0x53')](_0x166c85[_0x41048b]);}}if(_0x3b2718[a1_0x3d1a('0x55')]>0x0){const _0x18aa6c=_0x231af8[a1_0x3d1a('0x1a')](_0x2e6eec,_0x3b2718);for(const _0x34da76 of _0x3b2718){_0x5bd290['requests'][_0x34da76]=_0x18aa6c;}}});}function cloudEnabledTasksRunner(_0x16eadb,_0x32bd98,_0x263ebc,_0x171965=![]){var _0x25bf6b;const _0x23d726=process[a1_0x3d1a('0x3c')][a1_0x3d1a('0x1')];const _0xc5053b={'statuses':{},'scheduledTasks':[],'requests':{},'allTasks':_0x16eadb};const _0x4297a3=_0x32bd98['lifeCycle']===undefined;const _0xc79953=[];const _0x391ccb=new message_reporter_1['MessageReporter'](_0x32bd98);const _0x335a7a=createApi(_0x391ccb,_0x32bd98,_0xc5053b);const _0x19c44c=new end_of_run_message_1[(a1_0x3d1a('0x31'))](_0xc5053b,_0xc79953,_0x23d726);const _0x16ff64=new output_obfuscator_1[(a1_0x3d1a('0x35'))](_0x32bd98[a1_0x3d1a('0x46')]);const _0x6d4bae=new Date()[a1_0x3d1a('0x2a')]();const _0x28f1a4=createLifeCycle(_0xc5053b,_0x32bd98,_0x16ff64,_0xc79953);const _0x8ae904=environment_1[a1_0x3d1a('0x21')]||_0x32bd98[a1_0x3d1a('0x17')];const _0x2419e9=new e2e_encryption_1['E2EEncryption'](_0x8ae904);const _0x1c6d5f=new error_reporter_api_1['ErrorReporterApi'](_0x32bd98);const _0x403b49=(0x0,environment_1[a1_0x3d1a('0xb')])(_0x23d726)||!((_0x25bf6b=_0x263ebc[a1_0x3d1a('0x36')])===null||_0x25bf6b===void 0x0?void 0x0:_0x25bf6b[a1_0x3d1a('0x1e')]());const _0x22b9c1=new file_storage_1[(a1_0x3d1a('0x30'))](_0x2419e9,_0x1c6d5f,_0x32bd98,a1_0x3d1a('0x3e'));const _0x55902a=new cloud_remote_cache_1[(a1_0x3d1a('0x37'))](_0x391ccb,_0x335a7a,_0xc5053b,_0x22b9c1,_0x23d726,_0x403b49);fetchUrlsForKnownHashesUpfront(_0x335a7a,_0xc5053b,_0x16eadb,_0x32bd98,_0x23d726);delete process[a1_0x3d1a('0x3c')][a1_0x3d1a('0x1')];const _0x45f43f=tasksRunner(_0x16eadb,Object[a1_0x3d1a('0x32')](Object[a1_0x3d1a('0x32')]({},_0x32bd98),{'remoteCache':_0x55902a,'lifeCycle':_0x28f1a4}),_0x263ebc);if(_0x45f43f[a1_0x3d1a('0x10')]){const {Subject}=require('rxjs/internal/Subject');const _0x399cff=new Subject();_0x45f43f[a1_0x3d1a('0x10')]({'next':_0x5e1c34=>_0x399cff[a1_0x3d1a('0xc')](_0x5e1c34),'error':_0x1dddfa=>_0x399cff[a1_0x3d1a('0x3')](_0x1dddfa),'complete':()=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x3bf7ed=yield onComplete({'daemon':_0x263ebc[a1_0x3d1a('0x36')],'options':_0x32bd98,'fileStorage':_0x22b9c1,'remoteCache':_0x55902a,'api':_0x335a7a,'outputObfuscator':_0x16ff64,'runStartTime':_0x6d4bae,'messages':_0x391ccb,'endOfRunMessage':_0x19c44c,'taskExecutions':_0xc79953,'versionOfNxBefore133':_0x4297a3,'inner':_0x171965,'encryptionKey':_0x8ae904,'storeInCurrentProcess':_0x403b49,'runContext':_0xc5053b,'distributedExecutionId':_0x23d726});if(!_0x3bf7ed&&(0x0,environment_1[a1_0x3d1a('0xb')])(_0x23d726)){process[a1_0x3d1a('0x28')](environment_1[a1_0x3d1a('0x26')]);}_0x399cff['complete']();})});return _0x399cff;}else{return _0x45f43f[a1_0x3d1a('0x15')](_0x503bdf=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x213942=yield onComplete({'daemon':_0x263ebc[a1_0x3d1a('0x36')],'options':_0x32bd98,'fileStorage':_0x22b9c1,'remoteCache':_0x55902a,'api':_0x335a7a,'outputObfuscator':_0x16ff64,'runStartTime':_0x6d4bae,'messages':_0x391ccb,'endOfRunMessage':_0x19c44c,'taskExecutions':_0xc79953,'versionOfNxBefore133':_0x4297a3,'inner':_0x171965,'encryptionKey':_0x8ae904,'storeInCurrentProcess':_0x403b49,'runContext':_0xc5053b,'distributedExecutionId':_0x23d726});if(!_0x213942&&(0x0,environment_1[a1_0x3d1a('0xb')])(_0x23d726)){process['exit'](environment_1['DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE']);}return _0x503bdf;}))[a1_0x3d1a('0x4c')](_0x45b2bc=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x2bc79c=yield onComplete({'daemon':_0x263ebc[a1_0x3d1a('0x36')],'options':_0x32bd98,'fileStorage':_0x22b9c1,'remoteCache':_0x55902a,'api':_0x335a7a,'outputObfuscator':_0x16ff64,'runStartTime':_0x6d4bae,'messages':_0x391ccb,'endOfRunMessage':_0x19c44c,'taskExecutions':_0xc79953,'versionOfNxBefore133':_0x4297a3,'inner':_0x171965,'encryptionKey':_0x8ae904,'storeInCurrentProcess':_0x403b49,'runContext':_0xc5053b,'distributedExecutionId':_0x23d726});if(!_0x2bc79c&&(0x0,environment_1[a1_0x3d1a('0xb')])(_0x23d726)){process[a1_0x3d1a('0x28')](environment_1[a1_0x3d1a('0x26')]);}throw _0x45b2bc;}));}}exports[a1_0x3d1a('0x38')]=cloudEnabledTasksRunner;