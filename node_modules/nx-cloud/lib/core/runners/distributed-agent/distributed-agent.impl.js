const a6_0x1cdc=['../../../utilities/metric-logger','encryptionKey','__esModule','Agent\x20was\x20terminated\x20via\x20SIGINT','apply','nx-cloud','E2EEncryption','default','CIRCLECI','startAgent','yargs-parser','../../error/print-invalid-runner-error','then','strip-json-comments','Nx\x20Cloud:\x20Workspace\x20is\x20disabled','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.','floor','../../api/error-reporter.api','random','filter','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.','done','@nrwl/nx-cloud','runner','options','../../../utilities/dte-artifact-storage','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks','writeFileSync','next','printRunGroupError','ENCRYPTION_KEY','printCacheableTargetsError','readFileSync','length','CIRCLE_JOB','Critical\x20Error\x20in\x20Agent:\x20\x22','/lockfiles','argv','readdirSync','../../error/print-cacheable-targets-error','value','map','SIGINT','getRunGroup','If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.','SIGTERM','./invoke-tasks-using-run-many','../../file-storage/e2e-encryption','Distributed\x20Task\x20Execution\x20is\x20disabled\x20when\x20your\x20workspace\x20is\x20disabled','unlinkSync','DistributedAgentApi','cacheableOperations','defineProperty','We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.','warn','We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','getCIExecutionEnv','CIRCLE_STAGE','note','Agent\x20','.lock','throw','getCIExecutionId','includes','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20target(s)\x20[','ErrorReporterApi','Duplicate\x20Agent\x20ID\x20Detected','error','join','existsSync','FileStorage','Other\x20Nx\x20Cloud\x20Agents\x20Detected','trim','./execute-tasks','completeRunGroupWithError','../../file-storage/file-storage','env','some','NX_AGENT_NAME','exit','parse','Organization\x20administrators\x20can\x20find\x20more\x20information\x20on\x20the\x20\x27Billing\x20and\x20Plans\x27\x20page\x20in\x20the\x20Nx\x20Cloud\x20Webapp','targets','DteArtifactStorage','./invoke-tasks-using-nx-imperative-api'];(function(_0x251b4e,_0x1cdc5a){const _0x522a33=function(_0x59c859){while(--_0x59c859){_0x251b4e['push'](_0x251b4e['shift']());}};_0x522a33(++_0x1cdc5a);}(a6_0x1cdc,0x100));const a6_0x522a=function(_0x251b4e,_0x1cdc5a){_0x251b4e=_0x251b4e-0x0;let _0x522a33=a6_0x1cdc[_0x251b4e];return _0x522a33;};'use strict';var __awaiter=this&&this['__awaiter']||function(_0x59e3ee,_0x491164,_0x47508c,_0x1b4b61){function _0x44daf4(_0x2d92b9){return _0x2d92b9 instanceof _0x47508c?_0x2d92b9:new _0x47508c(function(_0x2e81d2){_0x2e81d2(_0x2d92b9);});}return new(_0x47508c||(_0x47508c=Promise))(function(_0xb58362,_0x7740d7){function _0x429944(_0x3a5873){try{_0x51f8db(_0x1b4b61['next'](_0x3a5873));}catch(_0x39f165){_0x7740d7(_0x39f165);}}function _0x4aa999(_0x1b255c){try{_0x51f8db(_0x1b4b61[a6_0x522a('0x3c')](_0x1b255c));}catch(_0xa96b82){_0x7740d7(_0xa96b82);}}function _0x51f8db(_0x295942){_0x295942[a6_0x522a('0x14')]?_0xb58362(_0x295942[a6_0x522a('0x27')]):_0x44daf4(_0x295942[a6_0x522a('0x27')])[a6_0x522a('0xb')](_0x429944,_0x4aa999);}_0x51f8db((_0x1b4b61=_0x1b4b61[a6_0x522a('0x3')](_0x59e3ee,_0x491164||[]))[a6_0x522a('0x1b')]());});};Object[a6_0x522a('0x33')](exports,a6_0x522a('0x1'),{'value':!![]});exports[a6_0x522a('0x8')]=void 0x0;const fs_1=require('fs');const stripJsonComments=require(a6_0x522a('0xc'));const yargsParser=require(a6_0x522a('0x9'));const environment_1=require('../../../utilities/environment');const metric_logger_1=require(a6_0x522a('0x54'));const print_cacheable_targets_error_1=require(a6_0x522a('0x26'));const print_invalid_runner_error_1=require(a6_0x522a('0xa'));const print_run_group_error_1=require('../../error/print-run-group-error');const distributed_agent_api_1=require('./distributed-agent.api');const execute_tasks_1=require(a6_0x522a('0x48'));const dte_artifact_storage_1=require(a6_0x522a('0x18'));const file_storage_1=require(a6_0x522a('0x4a'));const e2e_encryption_1=require(a6_0x522a('0x2e'));const error_reporter_api_1=require(a6_0x522a('0x10'));const invoke_tasks_using_run_many_1=require(a6_0x522a('0x2d'));const invoke_tasks_using_nx_imperative_api_1=require(a6_0x522a('0x53'));const is_workspace_enabled_1=require('../../../utilities/is-workspace-enabled');const {output,initTasksRunner,workspaceRoot,cacheDirectory}=require('../../../utilities/nx-imports');const args=yargsParser(process[a6_0x522a('0x24')],{'array':[a6_0x522a('0x51')],'default':{}});if(args[a6_0x522a('0x51')]&&args['targets'][a6_0x522a('0x20')]===0x1){args[a6_0x522a('0x51')]=args[a6_0x522a('0x51')][0x0]['split'](',')[a6_0x522a('0x28')](_0x129218=>_0x129218[a6_0x522a('0x47')]());}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x55e862=(0x0,environment_1['getBranch'])();const _0x29786a=(0x0,environment_1[a6_0x522a('0x2a')])();const _0x5d0882=(0x0,environment_1[a6_0x522a('0x3d')])();const _0x47fb50=(0x0,environment_1[a6_0x522a('0x37')])();if(!(0x0,print_run_group_error_1['canDetectRunGroup'])(_0x29786a,_0x5d0882)){(0x0,print_run_group_error_1[a6_0x522a('0x1c')])();process[a6_0x522a('0x4e')](0x1);}if(args[a6_0x522a('0x51')]&&args['targets'][a6_0x522a('0x20')]){output[a6_0x522a('0x39')]({'title':a6_0x522a('0x3f')+args[a6_0x522a('0x51')][a6_0x522a('0x43')](',\x20')+']'});}else{output[a6_0x522a('0x39')]({'title':a6_0x522a('0x19')});}const _0xadd020=JSON[a6_0x522a('0x4f')](stripJsonComments((0x0,fs_1[a6_0x522a('0x1f')])(workspaceRoot+'/nx.json')['toString']()))['tasksRunnerOptions'][a6_0x522a('0x6')];if(_0xadd020['runner']!==a6_0x522a('0x4')&&_0xadd020[a6_0x522a('0x16')]!==a6_0x522a('0x15')){(0x0,print_invalid_runner_error_1['printInvalidRunnerError'])();return process[a6_0x522a('0x4e')](0x1);}const _0x2dd6f9=_0xadd020[a6_0x522a('0x17')];if(args[a6_0x522a('0x51')]&&args[a6_0x522a('0x51')][a6_0x522a('0x4c')](_0x5330eb=>{var _0x14433a;return!((_0x14433a=_0x2dd6f9[a6_0x522a('0x32')])===null||_0x14433a===void 0x0?void 0x0:_0x14433a[a6_0x522a('0x3e')](_0x5330eb));})){const _0x5e07a1=args[a6_0x522a('0x51')][a6_0x522a('0x12')](_0x151929=>{var _0x519679;return!((_0x519679=_0x2dd6f9[a6_0x522a('0x32')])===null||_0x519679===void 0x0?void 0x0:_0x519679['includes'](_0x151929));});(0x0,print_cacheable_targets_error_1[a6_0x522a('0x1e')])(_0x5e07a1);return process['exit'](0x1);}const _0x3d9fb5=yield(0x0,is_workspace_enabled_1['isWorkspaceEnabled'])(_0x2dd6f9);if(!_0x3d9fb5){output['error']({'title':a6_0x522a('0xd'),'bodyLines':[a6_0x522a('0x2f'),'',a6_0x522a('0x50')]});process[a6_0x522a('0x4e')](0x1);}const _0x34ec7d=getAgentName();const _0x275209=new distributed_agent_api_1[(a6_0x522a('0x31'))](_0x2dd6f9,_0x55e862,_0x29786a,_0x5d0882,_0x47fb50,_0x34ec7d);createAgentLockfileAndSetUpListeners(_0x275209,_0x2dd6f9,_0x34ec7d);const _0x1064ab=new e2e_encryption_1[(a6_0x522a('0x5'))](environment_1[a6_0x522a('0x1d')]||_0x2dd6f9[a6_0x522a('0x0')]);const _0x33e7c5=new error_reporter_api_1[(a6_0x522a('0x40'))](_0x2dd6f9);const _0x163bdc=new dte_artifact_storage_1[(a6_0x522a('0x52'))](new file_storage_1[(a6_0x522a('0x45'))](_0x1064ab,_0x33e7c5,_0x2dd6f9,'dte-agent'),cacheDirectory);const _0x4810a9=initTasksRunner?yield(0x0,invoke_tasks_using_nx_imperative_api_1['invokeTasksUsingNxImperativeApi'])(_0x2dd6f9):yield(0x0,invoke_tasks_using_run_many_1['invokeTasksUsingRunMany'])();return(0x0,execute_tasks_1['executeTasks'])(_0x34ec7d,_0x275209,_0x163bdc,_0x4810a9,args[a6_0x522a('0x51')])['then'](_0x55a075=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1['submitRunMetrics'])(_0x2dd6f9);return _0x55a075;}))['catch'](_0x230b16=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x275209[a6_0x522a('0x49')](a6_0x522a('0x22')+_0x230b16['message']+'\x22');throw _0x230b16;}));});}exports[a6_0x522a('0x8')]=startAgent;function getAgentName(){if(process['env'][a6_0x522a('0x4d')]!==undefined){return process[a6_0x522a('0x4b')][a6_0x522a('0x4d')];}else if(process['env'][a6_0x522a('0x7')]!==undefined&&process[a6_0x522a('0x4b')][a6_0x522a('0x38')]){return process[a6_0x522a('0x4b')]['CIRCLE_STAGE'];}else if(process[a6_0x522a('0x4b')][a6_0x522a('0x7')]!==undefined&&process[a6_0x522a('0x4b')][a6_0x522a('0x21')]){return process[a6_0x522a('0x4b')][a6_0x522a('0x21')];}else{return a6_0x522a('0x3a')+Math[a6_0x522a('0xf')](Math[a6_0x522a('0x11')]()*0x186a0);}}function createAgentLockfileAndSetUpListeners(_0x55aed0,_0x5cff82,_0x2ce32a){const _0x1a06b4=cacheDirectory+a6_0x522a('0x23');const _0xc6d129=_0x1a06b4+'/'+_0x2ce32a+a6_0x522a('0x3b');if(!(0x0,fs_1[a6_0x522a('0x44')])(_0x1a06b4)){(0x0,fs_1['mkdirSync'])(_0x1a06b4,{'recursive':!![]});}const _0x1523dd=(0x0,fs_1[a6_0x522a('0x25')])(_0x1a06b4);if(_0x1523dd[a6_0x522a('0x20')]){if(_0x1523dd['includes'](_0x2ce32a+'.lock')){output[a6_0x522a('0x42')]({'title':a6_0x522a('0x41'),'bodyLines':[a6_0x522a('0x36'),'',a6_0x522a('0xe')]});process[a6_0x522a('0x4e')](0x1);}output[a6_0x522a('0x35')]({'title':a6_0x522a('0x46'),'bodyLines':[a6_0x522a('0x34'),'',a6_0x522a('0x13'),a6_0x522a('0x2b')]});}(0x0,fs_1[a6_0x522a('0x1a')])(_0xc6d129,'');process['on'](a6_0x522a('0x4e'),_0x2149d0=>{cleanupAgentLockfile(_0xc6d129,_0x2149d0);});process['on'](a6_0x522a('0x2c'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x55aed0[a6_0x522a('0x49')]('Agent\x20was\x20terminated\x20via\x20SIGTERM');cleanupAgentLockfile(_0xc6d129,0x1);}));process['on'](a6_0x522a('0x29'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x55aed0['completeRunGroupWithError'](a6_0x522a('0x2'));cleanupAgentLockfile(_0xc6d129,0x1);}));}function cleanupAgentLockfile(_0x10580c,_0x39677e){if((0x0,fs_1[a6_0x522a('0x44')])(_0x10580c)){(0x0,fs_1[a6_0x522a('0x30')])(_0x10580c);process[a6_0x522a('0x4e')](_0x39677e);}}